#cloud-config
package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - gnupg

write_files:
  - path: /opt/optibot/setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      echo "=== Installing Docker ==="
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg

      echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
        https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
        tee /etc/apt/sources.list.d/docker.list > /dev/null

      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      echo "=== Creating directories ==="
      mkdir -p /opt/optibot/chroma_storage
      mkdir -p /var/log/optibot

      echo "=== Logging into GitHub Container Registry ==="
      echo "${github_token}" | docker login ghcr.io -u "${github_username}" --password-stdin

      echo "=== Pulling Docker image ==="
      docker pull ${docker_image}

      echo "=== Running API container ==="
      docker run -d --name optibot-api \
        -p 80:8000 \
        -e GEMINI_API_KEY="${gemini_api_key}" \
        -v /opt/optibot/chroma_storage:/app/chroma_storage \
        --restart unless-stopped \
        ${docker_image}

      echo "=== Setting up cron job for daily scraper ==="
      cat > /opt/optibot/run_scraper.sh << 'CRONSCRIPT'
      #!/bin/bash
      echo "=== Starting daily scraper job at $(date) ===" >> /var/log/optibot/scraper.log
      docker run --rm \
        -e GEMINI_API_KEY="${gemini_api_key}" \
        -v /opt/optibot/chroma_storage:/app/chroma_storage \
        ${docker_image} \
        python -m scraper.daily_job >> /var/log/optibot/scraper.log 2>&1
      echo "=== Completed daily scraper job at $(date) ===" >> /var/log/optibot/scraper.log
      CRONSCRIPT

      chmod +x /opt/optibot/run_scraper.sh

      # Add cron job (runs at 2 AM daily)
      (crontab -l 2>/dev/null; echo "0 2 * * * /opt/optibot/run_scraper.sh") | crontab -

      echo "=== Setup completed ==="
      echo "API running at: http://$(curl -s ifconfig.me)"
      echo "Swagger UI at: http://$(curl -s ifconfig.me)/docs"

runcmd:
  - /opt/optibot/setup.sh

final_message: 'Optibot VM setup completed after $UPTIME seconds'
